rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is the admin of the club (using get for external documents)
    function isClubAdmin(clubId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/clubs/$(clubId)).data.adminId == request.auth.uid;
    }

    // Helper function to check if user is a helper of the club (using get for external documents)
    function isClubHelper(clubId) {
      return isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.helperIds;
    }

    // Helper function to check if user has management rights (Admin or Helper)
    function hasManagementRights(clubId) {
      return isClubAdmin(clubId) || isClubHelper(clubId);
    }

    // Rules for Clubs collection
    match /clubs/{clubId} {
      // Anyone can read clubs (for listing)
      allow read: if true;
      
      // Only authenticated users can create a club
      allow create: if isAuthenticated();
      
      // Allow update if the user is admin or helper of THIS club
      allow update: if isAuthenticated() && (
        resource.data.adminId == request.auth.uid ||
        request.auth.uid in resource.data.helperIds
      );
      
      // Only the admin can delete
      allow delete: if isAuthenticated() && resource.data.adminId == request.auth.uid;

      // Rules for Courts subcollection
      match /courts/{courtId} {
        // Anyone can read courts (to book)
        allow read: if true;
        
        // Only admins and helpers can manage courts
        allow create, update, delete: if hasManagementRights(clubId);
      }
    }
    
    // Rules for Users collection
    match /users/{userId} {
      // Users can read other users (for search/profile)
      allow read: if isAuthenticated();
      
      // Users can write their own document fully
      allow write: if request.auth.uid == userId;
      
      // Allow other users to update only followers array (for follow/unfollow)
      allow update: if isAuthenticated() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followers']);
    }

    // Rules for Reservations collection
    match /reservations/{reservationId} {
      
      // Helper to check if user manages the club of this reservation
      function managesClub() {
        return hasManagementRights(resource.data.clubId);
      }

      // Allow read if authenticated (needed for availability checks)
      allow read: if isAuthenticated();
      
      // Create: Authenticated users can create their own reservations
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;

      // Update rules:
      // 1. Club managers can update anything (approve/reject/etc)
      // 2. Owner can cancel their reservation
      // 3. Authenticated users can join matches (update team2Ids and status)
      allow update: if isAuthenticated() && (
        managesClub() || 
        // Owner can cancel
        (request.auth.uid == resource.data.userId && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'cancellationReason']) &&
         request.resource.data.status == 'cancelled') ||
        // Anyone can join a match (update team2Ids, optionally status)
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['team2Ids', 'status'])
      );
    }
  }
}
