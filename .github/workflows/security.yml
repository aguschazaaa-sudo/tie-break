name: Security Scan

on:
  workflow_run:
    workflows: ["Build & Test"]
    types: [completed]
    branches: [ "main", "master" ]

jobs:
  security:
    name: üîí Security Scan (Trivy)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: Security scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'

      - name: Check vulnerability thresholds
        run: |
          MAX_CRITICAL=1
          MAX_HIGH=5
          
          if [ ! -f trivy-results.json ]; then
            echo "‚úÖ No trivy results file found, skipping check"
            exit 0
          fi
          
          CRITICAL_COUNT=$(cat trivy-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length')
          HIGH_COUNT=$(cat trivy-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length')
          
          echo "üìä Vulnerability Summary:"
          echo "   CRITICAL: $CRITICAL_COUNT (max allowed: $MAX_CRITICAL)"
          echo "   HIGH: $HIGH_COUNT (max allowed: $MAX_HIGH)"
          
          FAILED=0
          
          if [ "$CRITICAL_COUNT" -gt "$MAX_CRITICAL" ]; then
            echo "‚ùå CRITICAL vulnerabilities exceed threshold!"
            FAILED=1
          fi
          
          if [ "$HIGH_COUNT" -gt "$MAX_HIGH" ]; then
            echo "‚ùå HIGH vulnerabilities exceed threshold!"
            FAILED=1
          fi
          
          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "üìã Vulnerability Details:"
            cat trivy-results.json | jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH") | "[\(.Severity)] \(.VulnerabilityID): \(.PkgName) - \(.Title // "No title")"'
            exit 1
          fi
          
          echo "‚úÖ Vulnerability check passed!"

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: trivy-results.json
          retention-days: 30
